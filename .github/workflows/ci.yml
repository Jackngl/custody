name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements_test.txt

      - name: Run Black (Formatting)
        run: |
          black --check custom_components/custody_schedule tests

      - name: Run Isort (Import sorting)
        run: |
          isort --check-only custom_components/custody_schedule tests

      - name: Run Flake8 (Linting)
        run: |
          # F401: Module imported but not used (ignored in __init__.py often, but good to check)
          # E501: Line too long (handled by black mostly, but flake8 is strict)
          # W503: Line break before binary operator (conflicts with black)
          flake8 custom_components/custody_schedule tests --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 custom_components/custody_schedule tests --count --max-complexity=10 --max-line-length=127 --statistics

      - name: Run YamlLint
        run: |
          yamllint .

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install bandit

      - name: Run Bandit (Security)
        run: |
          bandit -r custom_components/custody_schedule

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements_test.txt

      - name: Run Pytest
        run: |
          pytest tests

  hassfest:
    name: Hassfest Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Hassfest
        uses: home-assistant/actions/hassfest@master

  hacs:
    name: HACS Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run HACS Validation
        uses: hacs/action@main
        with:
          category: integration
          ignore: brands
